{% extends "base.html" %}

{% block page_title %}Listino Prodotti{% endblock %}

{% block content %}
<div class="flex flex-col h-[calc(100vh-140px)]">
    
    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
        <form method="get" action="/admin/products" class="flex flex-col md:flex-row gap-4 items-end">
            
            <div class="flex-1 w-full">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Azienda</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                        <i class="fa-solid fa-building"></i>
                    </span>
                    <input type="text" name="search_company" value="{{ search_company or '' }}" placeholder="Es. Mapei..." 
                           class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
            </div>

            <div class="flex-1 w-full">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Nome o Descrizione</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                        <i class="fa-solid fa-cube"></i>
                    </span>
                    <input type="text" name="search_product" value="{{ search_product or '' }}" placeholder="Es. Adesivo..." 
                           class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
            </div>

            <div class="flex-1 w-full">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Categoria</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                        <i class="fa-solid fa-tag"></i>
                    </span>
                    <input type="text" name="search_category" value="{{ search_category or '' }}" placeholder="Es. Isolanti..." 
                           class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                </div>
            </div>

            <div class="flex gap-2">
                <button type="submit" class="bg-slate-800 text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition-colors shadow-lg flex items-center h-[38px]">
                    <i class="fa-solid fa-filter mr-2"></i> Filtra
                </button>
                
                {% if search_company or search_product or search_category %}
                <a href="/admin/products" class="bg-white text-red-500 border border-red-200 px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-50 transition-colors flex items-center justify-center h-[38px]" title="Resetta Filtri">
                    <i class="fa-solid fa-times"></i>
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="flex justify-end mb-2">
         <a href="/admin/ingest" class="text-xs font-bold text-brand-600 hover:text-brand-800 flex items-center bg-brand-50 px-3 py-1 rounded-full border border-brand-100 hover:border-brand-300 transition-all">
            <i class="fa-solid fa-magic mr-2"></i> Aggiungi con AI
        </a>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col">
        <div class="overflow-y-auto flex-1">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">Prodotto</th>
                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">Produttore</th>
                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">Categoria</th>
                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 text-center">Stato Doc.</th>
                        <th class="px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 text-right">Azioni</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for p in products %}
                    <tr class="hover:bg-slate-50 transition-colors group">
                        <td class="px-6 py-3">
                            <div class="font-bold text-slate-800">{{ p.name }}</div>
                            <div class="text-xs text-slate-400 truncate max-w-xs">{{ p.description or '' }}</div>
                        </td>
                        <td class="px-6 py-3">
                            <div class="text-sm font-medium text-slate-700">
                                <i class="fa-solid fa-building text-slate-400 mr-1 text-xs"></i> 
                                {{ p.companies.name }}
                            </div>
                        </td>
                        <td class="px-6 py-3">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800 border border-slate-200">
                                {{ p.category }}
                            </span>
                        </td>
                        <td class="px-6 py-3 text-center">
                            <div class="flex justify-center space-x-1">
                                {% if p.epd_file_path or p.epd_url %}
                                <span class="w-6 h-6 rounded bg-green-100 text-green-600 flex items-center justify-center text-xs border border-green-200" title="EPD Presente">
                                    <i class="fa-solid fa-leaf"></i>
                                </span>
                                {% else %}
                                <span class="w-6 h-6 rounded bg-slate-50 text-slate-300 flex items-center justify-center text-xs border border-slate-100 opacity-50">
                                    <i class="fa-solid fa-leaf"></i>
                                </span>
                                {% endif %}

                                {% if p.tech_file_path or p.url_technical_sheet %}
                                <span class="w-6 h-6 rounded bg-blue-100 text-blue-600 flex items-center justify-center text-xs border border-blue-200" title="Scheda Tecnica Presente">
                                    <i class="fa-solid fa-file-lines"></i>
                                </span>
                                {% else %}
                                <span class="w-6 h-6 rounded bg-slate-50 text-slate-300 flex items-center justify-center text-xs border border-slate-100 opacity-50">
                                    <i class="fa-solid fa-file-lines"></i>
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-3 text-right">
                            <a href="/admin/products/{{ p.id }}" class="text-slate-400 hover:text-brand-600 transition-colors px-2 text-lg">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-slate-400">
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-filter text-4xl mb-3 opacity-30"></i>
                                <p class="font-medium">Nessun risultato con questi filtri.</p>
                                <p class="text-xs mt-1">Prova a rimuovere qualche criterio.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if total_pages > 1 %}
        <div class="bg-slate-50 border-t border-slate-200 px-6 py-3 flex items-center justify-between shadow-inner">
            <div class="text-xs text-slate-500">
                <span class="font-bold text-slate-700">{{ total_items }}</span> risultati
            </div>
            
            <div class="flex items-center space-x-1">
                {% if page > 1 %}
                <a href="/admin/products?page={{ page - 1 }}&search_company={{ search_company }}&search_product={{ search_product }}&search_category={{ search_category }}" 
                   class="px-3 py-1.5 bg-white border border-slate-300 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 hover:text-brand-600 transition-colors shadow-sm">
                   <i class="fa-solid fa-chevron-left mr-1"></i>
                </a>
                {% else %}
                <span class="px-3 py-1.5 bg-slate-100 border border-slate-200 rounded-md text-xs font-medium text-slate-400 cursor-not-allowed">
                   <i class="fa-solid fa-chevron-left mr-1"></i>
                </span>
                {% endif %}

                <span class="px-3 py-1.5 text-xs font-bold text-slate-700 bg-white border border-slate-200 rounded-md mx-1 shadow-sm">
                    {{ page }} / {{ total_pages }}
                </span>

                {% if page < total_pages %}
                <a href="/admin/products?page={{ page + 1 }}&search_company={{ search_company }}&search_product={{ search_product }}&search_category={{ search_category }}" 
                   class="px-3 py-1.5 bg-white border border-slate-300 rounded-md text-xs font-bold text-slate-600 hover:bg-slate-100 hover:text-brand-600 transition-colors shadow-sm">
                   <i class="fa-solid fa-chevron-right ml-1"></i>
                </a>
                {% else %}
                <span class="px-3 py-1.5 bg-slate-100 border border-slate-200 rounded-md text-xs font-medium text-slate-400 cursor-not-allowed">
                   <i class="fa-solid fa-chevron-right ml-1"></i>
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}