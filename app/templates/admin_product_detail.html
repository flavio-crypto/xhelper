{% extends "base.html" %}

{% block page_title %}Modifica Materiale{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto pb-20">

    <div class="flex items-center justify-between mb-6">
        <a href="/admin/products" class="text-slate-500 hover:text-slate-800 text-sm font-medium transition-colors">
            <i class="fa-solid fa-arrow-left mr-1"></i> Torna alla lista
        </a>
    </div>

    <form action="/admin/products/save" method="post" id="mainForm" class="space-y-6">
        <input type="hidden" name="id" value="{{ product.id }}">

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 class="text-lg font-bold text-slate-800">Dati Anagrafici</h2>
                <label class="flex items-center cursor-pointer relative">
                    <input type="checkbox" name="is_validated" value="true" class="sr-only peer" {% if product.is_validated %}checked{% endif %}>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-600"></div>
                    <span class="ml-3 text-sm font-bold text-slate-700">Validato</span>
                </label>
            </div>

            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-2 md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome Commerciale</label>
                    <input type="text" name="name" value="{{ product.name or '' }}" required class="w-full px-4 py-2 border border-slate-300 rounded-lg font-bold text-lg text-slate-800">
                </div>
                <div class="col-span-2 md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Produttore</label>
                    <select name="company_id" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
                        {% for comp in companies %}
                        <option value="{{ comp.id }}" {% if product.company_id == comp.id %}selected{% endif %}>{{ comp.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-span-2 md:col-span-1">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Categoria</label>
                    <select name="category" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if product.category == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                        <option value="Altro" {% if product.category == 'Altro' %}selected{% endif %}>Altro</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Descrizione</label>
                    <textarea name="description" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-600">{{ product.description or '' }}</textarea>
                </div>

                <div class="col-span-2 border-t border-slate-100 pt-6 mt-2">
                    <div class="flex items-center justify-between mb-4">
                        <label class="block text-sm font-bold text-slate-700 uppercase">Scheda Tecnica / Datasheet</label>
                        {% if not product.tech_file_path %}
                        <button type="button" onclick="openUploadModal('datasheet')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded border border-slate-300 font-bold">
                            <i class="fa-solid fa-cloud-arrow-up mr-1"></i> Carica PDF
                        </button>
                        {% endif %}
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Link Web (URL)</label>
                            <div class="flex">
                                <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-slate-300 bg-slate-50 text-slate-500 text-sm">
                                    <i class="fa-solid fa-link"></i>
                                </span>
                                <input type="text" id="url_tech_input" name="url_technical_sheet" value="{{ product.url_technical_sheet or '' }}" placeholder="https://..." 
                                       class="w-full px-3 py-2 border border-slate-300 border-r-0 text-sm text-blue-600 font-mono focus:ring-2 focus:ring-blue-500 outline-none">
                                <button type="button" onclick="openLink('url_tech_input')" 
                                        class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-slate-300 bg-slate-50 text-slate-500 hover:text-blue-600 hover:bg-slate-100 transition-colors" title="Apri Link in nuova scheda">
                                    <i class="fa-solid fa-arrow-up-right-from-square"></i>
                                </button>
                            </div>
                        </div>

                        {% if product.tech_file_path %}
                        <div class="flex items-center justify-between bg-purple-50 p-3 rounded-lg border border-purple-100">
                            <div class="flex items-center">
                                <a href="{{ product.tech_file_path }}" target="_blank" class="flex items-center text-sm text-purple-700 font-bold hover:underline">
                                    <i class="fa-solid fa-file-pdf mr-2"></i> Scheda Tecnica Archiviata
                                </a>
                            </div>
                            <a href="/admin/products/delete_doc/{{ product.id }}/datasheet" 
                               onclick="return confirm('Eliminare il file fisico?')"
                               class="text-red-400 hover:text-red-600 px-2 transition-colors">
                               <i class="fa-solid fa-trash"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-fit">
                <div class="px-6 py-3 border-b border-slate-100 bg-green-50/50 flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fa-solid fa-leaf text-green-600 mr-2"></i>
                        <h3 class="font-bold text-slate-800 text-sm">EPD</h3>
                    </div>
                    
                    <div class="flex space-x-1">
                        <button type="button" onclick="openShareModal('epd')" 
                                class="text-[10px] bg-white border border-slate-300 px-2 py-1 rounded hover:bg-green-100 hover:text-green-700 font-bold text-slate-500 transition-colors" title="Usa EPD esistente">
                            <i class="fa-solid fa-link"></i> Collega
                        </button>
                        
                        {% if not product.epd_file_path %}
                        <button type="button" onclick="openUploadModal('epd')" class="text-[10px] bg-white border border-slate-300 px-2 py-1 rounded hover:bg-slate-50 font-bold text-slate-600">
                            <i class="fa-solid fa-upload"></i> Carica
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="p-6 space-y-4">
                    
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tipologia EPD</label>
                        <div class="relative">
                            <select name="epd_type" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-green-500 outline-none appearance-none">
                                <option value="" class="text-slate-400">-- Seleziona Tipo --</option>
                                <option value="Industry-wide (generic) EPD" {% if product.epd_type == 'Industry-wide (generic) EPD' %}selected{% endif %}>
                                    Industry-wide (generic) EPD
                                </option>
                                <option value="Product-specific Type III EPD with third-party certification" {% if product.epd_type == 'Product-specific Type III EPD with third-party certification' %}selected{% endif %}>
                                    Product-specific Type III EPD (Certified)
                                </option>
                                <option value="Product-specific Type III EPD Internally Reviewed" {% if product.epd_type == 'Product-specific Type III EPD Internally Reviewed' %}selected{% endif %}>
                                    Product-specific Type III EPD (Internal)
                                </option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Link Web (URL)</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-slate-300 bg-slate-50 text-slate-500 text-sm">
                                <i class="fa-solid fa-globe"></i>
                            </span>
                            <input type="text" id="epd_url_input" name="epd_url" value="{{ product.epd_url or '' }}" placeholder="https://..." 
                                   class="w-full px-3 py-2 border border-slate-300 border-r-0 text-sm text-blue-600 font-mono focus:ring-2 focus:ring-green-500 outline-none">
                            <button type="button" onclick="openLink('epd_url_input')" 
                                    class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-slate-300 bg-slate-50 text-slate-500 hover:text-green-600 hover:bg-slate-100 transition-colors" title="Apri Link">
                                <i class="fa-solid fa-arrow-up-right-from-square"></i>
                            </button>
                        </div>
                    </div>

                    {% if product.epd_file_path %}
                    <div class="flex items-center justify-between bg-green-50 p-2 rounded border border-green-100">
                        <a href="{{ product.epd_file_path }}" target="_blank" class="flex items-center text-xs text-green-800 font-bold hover:underline">
                            <i class="fa-solid fa-file-pdf mr-2"></i> PDF Archiviato
                        </a>
                        <a href="/admin/products/delete_doc/{{ product.id }}/epd" 
                           onclick="return confirm('Eliminare il file EPD?')"
                           class="text-red-400 hover:text-red-600 px-2">
                           <i class="fa-solid fa-trash"></i>
                        </a>
                    </div>
                    {% endif %}
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Scadenza</label>
                        <input type="date" name="epd_expiration" value="{{ product.epd_expiration or '' }}" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-fit">
                <div class="px-6 py-3 border-b border-slate-100 bg-blue-50/50 flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fa-solid fa-wind text-blue-600 mr-2"></i>
                        <h3 class="font-bold text-slate-800 text-sm">Emissioni (VOC)</h3>
                    </div>
                    
                    <div class="flex space-x-1">
                        <button type="button" onclick="openShareModal('emission')" 
                                class="text-[10px] bg-white border border-slate-300 px-2 py-1 rounded hover:bg-blue-100 hover:text-blue-700 font-bold text-slate-500 transition-colors" title="Usa Certificato esistente">
                            <i class="fa-solid fa-link"></i> Collega
                        </button>

                        {% if not product.emission_file_path %}
                        <button type="button" onclick="openUploadModal('emission')" class="text-[10px] bg-white border border-slate-300 px-2 py-1 rounded hover:bg-slate-50 font-bold text-slate-600">
                            <i class="fa-solid fa-upload"></i> Carica
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="p-6 space-y-4">
                    
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Compliance LEED Protocol</h4>
                        <div class="flex flex-col gap-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" name="leed_v4" value="true" 
                                       class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                       {% if emission_data.leed_v4_compliant %}checked{% endif %}>
                                <span class="ml-2 text-xs font-bold text-slate-700">LEED v4</span>
                            </label>
                            
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" name="leed_v41" value="true" 
                                       class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                       {% if emission_data.leed_v41_compliant %}checked{% endif %}>
                                <span class="ml-2 text-xs font-bold text-slate-700">LEED v4.1</span>
                            </label>
                            
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" name="leed_v5" value="true" 
                                       class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                       {% if emission_data.leed_v5_compliant %}checked{% endif %}>
                                <span class="ml-2 text-xs font-bold text-slate-700">LEED v5 / Altro</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Link Web (URL)</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-slate-300 bg-slate-50 text-slate-500 text-sm">
                                <i class="fa-solid fa-globe"></i>
                            </span>
                            <input type="text" id="emission_url_input" name="emission_url" value="{{ product.emission_url or '' }}" placeholder="https://..." 
                                   class="w-full px-3 py-2 border border-slate-300 border-r-0 text-sm text-blue-600 font-mono focus:ring-2 focus:ring-blue-500 outline-none">
                            <button type="button" onclick="openLink('emission_url_input')" 
                                    class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-slate-300 bg-slate-50 text-slate-500 hover:text-blue-600 hover:bg-slate-100 transition-colors" title="Apri Link">
                                <i class="fa-solid fa-arrow-up-right-from-square"></i>
                            </button>
                        </div>
                    </div>

                    {% if product.emission_file_path %}
                    <div class="flex items-center justify-between bg-blue-50 p-2 rounded border border-blue-100">
                        <a href="{{ product.emission_file_path }}" target="_blank" class="flex items-center text-xs text-blue-800 font-bold hover:underline">
                            <i class="fa-solid fa-file-pdf mr-2"></i> PDF Archiviato
                        </a>
                        <a href="/admin/products/delete_doc/{{ product.id }}/emission" 
                           onclick="return confirm('Eliminare il file Emissioni?')"
                           class="text-red-400 hover:text-red-600 px-2">
                           <i class="fa-solid fa-trash"></i>
                        </a>
                    </div>
                    {% endif %}

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Scadenza</label>
                        <input type="date" name="emission_expiration" value="{{ product.emission_expiration or '' }}" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-fit md:col-span-2">
                 <div class="px-6 py-3 border-b border-slate-100 bg-orange-50/50 flex items-center">
                    <i class="fa-solid fa-recycle text-orange-600 mr-2"></i>
                    <h3 class="font-bold text-slate-800 text-sm">Economia Circolare</h3>
                </div>
                <div class="p-6 flex items-center justify-between">
                    <div>
                        <h4 class="font-bold text-slate-700 text-sm">Contenuto Riciclato</h4>
                        <p class="text-xs text-slate-500 mt-1">Attiva se la scheda tecnica dichiara presenza di materiale riciclato.</p>
                    </div>
                    <label class="flex items-center cursor-pointer relative">
                        <input type="checkbox" name="is_recycled" value="true" class="sr-only peer" {% if product.is_recycled %}checked{% endif %}>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                        <span class="ml-3 text-sm font-bold text-slate-700">Presente</span>
                    </label>
                </div>
            </div>

        </div>

        <div class="flex justify-end space-x-4 pt-4 border-t border-slate-200">
             <a href="/admin/products/delete/{{ product.id }}" onclick="return confirm('Eliminare definitivamente l\'intero prodotto?')" class="px-6 py-3 text-red-600 font-bold hover:bg-red-50 rounded-lg transition-colors"><i class="fa-solid fa-trash mr-2"></i> Elimina Prodotto</a>
            <button type="submit" class="px-8 py-3 bg-brand-600 text-white font-bold rounded-lg shadow-lg hover:bg-brand-700 transition-all">Salva Modifiche</button>
        </div>
    </form>
</div>

<div id="uploadModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4">
        <h3 class="text-lg font-bold text-slate-800 mb-4">Carica Documento</h3>
        <form action="/admin/products/upload_doc" method="post" enctype="multipart/form-data" class="space-y-4">
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <input type="hidden" name="doc_type" id="modalDocType">
            <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-brand-500 transition-colors bg-slate-50 relative">
                <input type="file" name="file" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                <p class="text-sm text-slate-500 font-medium">Trascina qui o clicca per selezionare</p>
                <p class="text-xs text-slate-400 mt-1">PDF consigliato</p>
            </div>
            <div class="flex justify-end space-x-3 pt-2">
                <button type="button" onclick="document.getElementById('uploadModal').classList.add('hidden')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-medium">Annulla</button>
                <button type="submit" class="px-4 py-2 bg-brand-600 text-white rounded-lg font-bold hover:bg-brand-700">Avvia Upload</button>
            </div>
        </form>
    </div>
</div>

<div id="shareModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4 flex flex-col max-h-[80vh]">
        <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-3">
            <div>
                <h3 class="text-lg font-bold text-slate-800">Collega Documento Esistente</h3>
                <p class="text-xs text-slate-500">Scegli da un altro prodotto di <span class="font-bold text-slate-700">{{ product.companies.name }}</span></p>
            </div>
            <button onclick="document.getElementById('shareModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>
        
        <div id="shareListContent" class="flex-1 overflow-y-auto min-h-[200px]">
            <div class="flex items-center justify-center h-full text-slate-400">
                <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Caricamento...
            </div>
        </div>

        <form id="shareForm" action="/admin/products/copy-doc-data" method="post" class="hidden">
            <input type="hidden" name="target_id" value="{{ product.id }}">
            <input type="hidden" name="source_id" id="shareSourceId">
            <input type="hidden" name="doc_type" id="shareDocType">
        </form>
    </div>
</div>

<script>
    // Apre il link contenuto nell'input
    function openLink(fieldId) {
        const url = document.getElementById(fieldId).value;
        if (url && url.trim() !== "") {
            window.open(url, '_blank');
        } else {
            alert("Inserisci prima un link valido.");
        }
    }

    function openUploadModal(type) {
        document.getElementById('modalDocType').value = type;
        document.getElementById('uploadModal').classList.remove('hidden');
        document.getElementById('uploadModal').classList.add('flex');
    }

    function openShareModal(type) {
        document.getElementById('shareModal').classList.remove('hidden');
        document.getElementById('shareModal').classList.add('flex');
        document.getElementById('shareDocType').value = type;
        
        const container = document.getElementById('shareListContent');
        container.innerHTML = '<div class="flex items-center justify-center h-32 text-slate-400"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Ricerca documenti...</div>';
        
        const companyId = "{{ product.company_id }}";
        const currentId = "{{ product.id }}";
        
        fetch(`/admin/products/share-candidates/${type}/${companyId}/${currentId}`)
            .then(response => response.text())
            .then(html => {
                container.innerHTML = html;
            });
    }

    function selectSourceProduct(sourceId) {
        if(confirm("Vuoi copiare i documenti da questo prodotto? I dati attuali verranno sovrascritti.")) {
            document.getElementById('shareSourceId').value = sourceId;
            document.getElementById('shareForm').submit();
        }
    }
</script>
{% endblock %}